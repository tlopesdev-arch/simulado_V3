<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simulado PMPA - T√©cnico em Enfermagem 2025</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3408/3408592.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, h4, .font-heading { font-family: 'Poppins', sans-serif; }

        .bg-main-gradient { background: linear-gradient(135deg, #4f46e5 0%, #0ea5e9 100%); }
        .shadow-soft { box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); }
        .blur-content { filter: blur(6px); user-select: none; pointer-events: none; }
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        .spinner-border { border-top-color: #4f46e5; animation: spinner 1s linear infinite; }
        @keyframes spinner { 100% { transform: rotate(360deg); } }
        .premium-shine { background: linear-gradient(45deg, #ffd700, #fff8db, #ffd700); background-size: 200% 200%; animation: shine 3s ease infinite; }
        @keyframes shine { 0% {background-position: 0% 50%;} 50% {background-position: 100% 50%;} 100% {background-position: 0% 50%;} }
        .option-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .transition-all { transition: all 0.2s ease-in-out; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; pointer-events: none; }
        .toast { background: white; padding: 12px 24px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transform: translateX(100%); transition: transform 0.3s ease; display: flex; align-items: center; gap: 12px; pointer-events: auto; border-left: 4px solid #4f46e5; }
        .toast.show { transform: translateX(0); }
        .toast.error { border-left-color: #ef4444; }
        .toast.success { border-left-color: #22c55e; }
        .admin-input-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; }
        .admin-input-item input { width: 100%; text-align: center; text-transform: uppercase; border: 1px solid #e2e8f0; border-radius: 8px; font-weight: bold; color: #475569; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col text-slate-800">

    <div id="toast-container"></div>

    <header class="fixed w-full top-0 z-40 bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
                <div class="w-8 h-8 rounded-lg bg-main-gradient flex items-center justify-center text-white shadow-lg"><i class="fas fa-heartbeat"></i></div>
                <div><h1 class="text-sm font-bold leading-none">Simulado PMPA</h1><p class="text-[10px] text-slate-500">Enfermagem 2025</p></div>
                <span id="user-badge" class="ml-1 text-[10px] font-bold bg-slate-100 px-2 py-0.5 rounded-full border border-slate-200">FREE</span>
            </div>
            <div class="flex items-center gap-3">
                <button id="btn-install-app" onclick="app.installPWA()" class="hidden md:flex items-center gap-2 text-xs font-semibold text-slate-600 bg-slate-100 hover:bg-slate-200 px-3 py-1.5 rounded-full transition"><i class="fas fa-download"></i> App</button>
                <div id="credits-display" class="flex items-center gap-2 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-xs font-semibold"><span id="credits-count">--</span> <span id="credits-total">/1</span></span>
                </div>
                <button id="btn-logout" onclick="app.logout()" class="hidden text-slate-400 hover:text-red-500"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        <div class="bg-slate-900 text-white text-[10px] py-1 text-center font-mono tracking-widest">PROVA EM: <span id="countdown-timer" class="font-bold text-yellow-400">...</span></div>
    </header>
    <div class="h-20"></div>

    <main class="flex-grow container mx-auto px-4 py-6 max-w-5xl">
        <div id="start-screen" class="animate-fade-in-up">
            <div class="relative bg-white rounded-3xl p-8 shadow-soft border border-slate-100 overflow-hidden mb-6">
                <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-50 rounded-full mix-blend-multiply filter blur-3xl opacity-70"></div>
                <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-8">
                    <div class="text-center md:text-left max-w-lg w-full">
                        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-50 text-indigo-600 text-xs font-bold mb-4 border border-indigo-100">Edital 122/2025</div>
                        <h2 class="text-3xl md:text-4xl font-bold text-slate-900 mb-2 font-heading">Sua Aprova√ß√£o <span class="text-transparent bg-clip-text bg-main-gradient">Come√ßa Aqui.</span></h2>
                        <div id="id-card" class="bg-slate-50 border border-slate-200 p-4 rounded-2xl shadow-sm max-w-sm mx-auto md:mx-0 relative overflow-hidden">
                            <div class="flex justify-between items-start mb-3">
                                <div><div class="text-[10px] font-bold uppercase tracking-widest text-slate-400" id="id-card-label">PLANO GRATUITO</div><div id="user-greeting" class="text-sm font-bold text-slate-700 mt-1">Ol√°, Visitante!</div></div>
                                <div id="user-avatar-container"><div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-slate-400 border border-slate-200"><i class="fas fa-user"></i></div></div>
                            </div>
                            <div class="relative group"><input type="text" id="username" placeholder="Crie seu Apelido..." maxlength="15" class="w-full pl-4 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                            <div class="flex justify-between items-center mt-2"><button onclick="app.openAuthModal()" class="text-[10px] font-bold text-indigo-600 hover:underline">Entrar / Criar Conta</button><span id="auth-status" class="text-[10px] text-slate-400"><i class="fas fa-circle-notch fa-spin"></i></span></div>
                        </div>
                    </div>
                    <div class="hidden md:block relative w-64">
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-lg text-center">
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-4">Probabilidade</h3>
                            <div class="relative w-32 h-32 mx-auto"><svg class="w-full h-full" viewBox="0 0 36 36"><path class="text-slate-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3.8"/><path id="gauge-path" class="text-indigo-500 transition-all duration-1000" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3.8"/></svg><div class="absolute inset-0 flex items-center justify-center flex-col"><span class="text-2xl font-bold text-slate-800" id="gauge-text">0%</span></div></div>
                            <button onclick="app.showUpgradeModal()" class="mt-4 text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full hover:bg-indigo-100">Aumentar üöÄ</button>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex flex-col sm:flex-row gap-3 justify-center md:justify-start border-t border-slate-100 pt-6">
                    <button onclick="app.startQuiz()" id="btn-start" class="bg-main-gradient text-white font-bold py-3.5 px-8 rounded-xl shadow-lg hover:shadow-indigo-500/30 transition transform hover:-translate-y-1 flex items-center justify-center gap-2"><i class="fas fa-play"></i> Iniciar</button>
                    <button onclick="app.openFlashcards()" class="bg-white border border-slate-200 text-slate-700 font-bold py-3.5 px-8 rounded-xl hover:bg-slate-50 transition flex items-center justify-center gap-2"><i class="fas fa-layer-group text-indigo-500"></i> Flashcards</button>
                    <button onclick="app.showUpgradeModal()" class="bg-yellow-50 border border-yellow-200 text-yellow-700 font-bold py-3.5 px-8 rounded-xl hover:bg-yellow-100 transition flex items-center justify-center gap-2"><i class="fas fa-crown"></i> Premium</button>
                </div>
                <p id="limit-warning" class="hidden mt-3 text-xs font-bold text-red-500 bg-red-50 inline-block px-3 py-1 rounded border border-red-100">Limite di√°rio atingido.</p>
                <div class="mt-4 text-center" id="admin-panel-trigger" style="display:none;"><button onclick="app.openAdminLoginModal()" class="text-[10px] text-slate-300 hover:text-slate-500 transition uppercase tracking-widest">Acesso Administrativo</button></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div onclick="app.openRealExamCorrection()" class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition cursor-pointer flex justify-between items-center group"><div><h4 class="font-bold text-slate-800 group-hover:text-teal-600">Corre√ß√£o Real</h4><p class="text-xs text-slate-500">Gabarito (21/12)</p></div><i class="fas fa-lock text-slate-300 group-hover:text-teal-500" id="real-exam-lock"></i></div>
                <div onclick="app.openLeaderboard()" class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition cursor-pointer flex justify-between items-center group"><div><h4 class="font-bold text-slate-800 group-hover:text-blue-600">Ranking Global</h4><p class="text-xs text-slate-500">Compare notas</p></div><i class="fas fa-chart-bar text-blue-200 group-hover:text-blue-500"></i></div>
                <div onclick="app.openComparisonModal()" class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition cursor-pointer flex justify-between items-center"><div><h4 class="font-bold text-slate-800">Comparar</h4><p class="text-xs text-slate-500">Planos</p></div><i class="fas fa-table text-purple-200"></i></div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden flex flex-col min-h-[70vh] animate-fade-in-up">
            <div class="bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden flex-grow relative">
                <div id="loading-overlay" class="absolute inset-0 bg-white/90 z-20 hidden flex-col items-center justify-center"><div class="spinner-border w-10 h-10 border-4 rounded-full text-indigo-600"></div></div>
                <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center"><span id="question-category" class="text-xs font-bold uppercase text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">...</span><span id="question-weight" class="text-xs font-bold bg-white border px-2 py-0.5 rounded">1.0</span></div>
                <div class="p-6 md:p-10"><h3 id="question-text" class="text-lg font-medium text-slate-800 mb-6 font-heading leading-relaxed">...</h3><div id="options-container" class="space-y-3"></div></div>
            </div>
            <div class="flex justify-between mt-6">
                 <button onclick="app.prevQuestion()" id="prev-btn" class="text-slate-400 hover:text-slate-600 px-4 py-2 hidden"><i class="fas fa-arrow-left"></i> Anterior</button>
                 <div class="flex gap-2 ml-auto"><button onclick="app.showJumpMenu()" class="bg-white border px-4 py-2 rounded text-slate-600 text-sm">Mapa</button><button onclick="app.nextQuestion()" id="next-btn" class="bg-indigo-600 text-white px-8 py-2 rounded-lg shadow hover:bg-indigo-700 font-bold">Pr√≥xima</button><button onclick="app.finishQuiz()" id="finish-btn" class="hidden bg-green-600 text-white px-8 py-2 rounded-lg shadow hover:bg-green-700 font-bold">Entregar</button></div>
            </div>
        </div>

        <!-- Flashcards Screen -->
        <div id="flashcards-screen" class="hidden flex flex-col min-h-[70vh] animate-fade-in-up">
            <div class="bg-white rounded-3xl shadow-soft border border-slate-100 p-6 flex-grow relative flex flex-col items-center justify-center">
                <div class="absolute top-4 left-6 text-sm font-bold text-slate-400" id="flashcard-counter">1/5</div>
                <button onclick="location.reload()" class="absolute top-4 right-6 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
                <div class="perspective w-full max-w-md h-64 cursor-pointer group" onclick="this.querySelector('.flashcard-inner').classList.toggle('flipped')">
                    <div class="flashcard-inner w-full h-full relative transition-transform duration-700 transform-style-3d">
                        <div class="flashcard-front absolute w-full h-full bg-white border-2 border-slate-100 rounded-2xl shadow-sm flex items-center justify-center p-8 text-center backface-hidden"><div><span class="text-xs uppercase font-bold text-indigo-500 tracking-widest mb-2 block">Pergunta</span><h3 class="text-xl font-bold text-slate-800" id="fc-front">...</h3><p class="text-xs text-slate-400 mt-4 font-medium"><i class="fas fa-sync mr-1"></i> Toque para virar</p></div></div>
                        <div class="flashcard-back absolute w-full h-full bg-gradient-to-br from-indigo-600 to-blue-600 rounded-2xl shadow-lg flex items-center justify-center p-8 text-center backface-hidden text-white rotate-y-180"><div><span class="text-xs uppercase font-bold text-indigo-200 tracking-widest mb-2 block">Resposta</span><p class="text-lg font-medium leading-relaxed" id="fc-back">...</p></div></div>
                    </div>
                </div>
                <div class="flex gap-4 mt-10"><button onclick="app.nextFlashcard()" class="bg-red-100 text-red-600 px-6 py-3 rounded-xl font-bold hover:bg-red-200">Dif√≠cil</button><button onclick="app.nextFlashcard()" class="bg-green-100 text-green-600 px-6 py-3 rounded-xl font-bold hover:bg-green-200">F√°cil</button></div>
                <div id="fc-lock" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-10 hidden flex-col items-center justify-center text-center p-8"><i class="fas fa-lock text-4xl text-yellow-500 mb-4"></i><h3 class="font-bold text-xl text-slate-800">Bloqueado</h3><p class="text-sm text-slate-500 mb-6">Flashcards ilimitados apenas Gold.</p><button onclick="app.showUpgradeModal()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg">Desbloquear</button></div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="result-screen" class="hidden pb-12">
            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden relative mb-6">
                <div class="bg-main-gradient p-8 text-white text-center"><h2 class="text-xs uppercase font-bold opacity-80">Nota Final</h2><div class="text-6xl font-extrabold font-heading"><span id="final-score">0</span> <span class="text-2xl opacity-50">/ 80</span></div></div>
                <div class="p-4 flex justify-center gap-3 bg-slate-50 border-t"><button onclick="app.openLeaderboard()" class="text-xs font-bold text-slate-600 bg-white border px-4 py-2 rounded">Ranking</button><button onclick="location.reload()" class="text-xs font-bold text-white bg-indigo-600 px-4 py-2 rounded">Novo</button></div>
            </div>
            <div class="flex border-b border-slate-200 mb-6 overflow-x-auto gap-6 px-2">
                <button onclick="app.switchTab('review')" id="tab-btn-review" class="pb-3 text-indigo-600 border-b-2 border-indigo-600 font-bold">Gabarito</button>
                <button onclick="app.switchTab('discursive')" id="tab-btn-discursive" class="pb-3 text-slate-400 hover:text-yellow-600 border-b-2 border-transparent hidden font-medium">Discursiva</button>
            </div>
            <div id="tab-review" class="tab-content">
                <div class="flex gap-2 mb-6 justify-end"><button onclick="app.filterReview('all')" class="px-4 py-1.5 text-xs rounded-full bg-white border">Todas</button><button onclick="app.filterReview('wrong')" class="px-4 py-1.5 text-xs rounded-full bg-red-50 text-red-600 border border-red-100">Erros</button></div>
                <div id="review-container" class="space-y-4"></div>
                <div id="review-premium-block" class="hidden mt-8 p-8 bg-slate-800 rounded-2xl text-center text-white shadow-xl cursor-pointer" onclick="app.showUpgradeModal()"><i class="fas fa-lock text-3xl mb-2 text-slate-400"></i><h3 class="font-bold">Coment√°rios Bloqueados</h3><button class="mt-3 bg-yellow-400 text-yellow-900 text-xs font-bold px-4 py-2 rounded">Desbloquear</button></div>
            </div>
            <div id="tab-discursive" class="tab-content hidden"><div class="bg-white rounded-3xl shadow-soft border border-yellow-100 p-8"><h3 class="font-bold text-xl text-slate-800 mb-4">Estudo de Caso</h3><p id="discursive-text" class="text-slate-700 italic bg-slate-50 p-4 rounded"></p><div class="mt-4 p-4 bg-emerald-50 text-sm"><p id="discursive-answer"></p></div></div></div>
        </div>
    </main>

    <!-- Modals: Auth, Upgrade, Checkout, Leaderboard, Admin, RealExam, JumpMenu -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-slate-900/90 z-[70] flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-8 text-center"><h3 class="font-bold text-xl mb-6">Login</h3><button onclick="app.handleGoogleLogin()" class="w-full bg-white border font-bold py-3 rounded-lg flex justify-center gap-2 mb-4 text-sm text-slate-700"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-4"> Google</button><div class="text-[10px] text-slate-400 my-3">OU EMAIL</div><input id="auth-email" type="email" placeholder="Email" class="w-full border p-2 rounded mb-2 text-sm"><input id="auth-pass" type="password" placeholder="Senha" class="w-full border p-2 rounded mb-4 text-sm"><button onclick="app.handleAuth()" class="w-full bg-indigo-600 text-white font-bold py-2 rounded">Entrar</button><button onclick="document.getElementById('auth-modal').classList.add('hidden')" class="mt-4 text-xs text-slate-400">Cancelar</button></div></div>
    
    <div id="upgrade-modal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto"><div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-6 pt-10 pb-10"><div class="bg-white rounded-2xl shadow-2xl border-4 border-slate-100 p-6 text-center"><h3 class="text-2xl font-bold text-slate-600">SILVER</h3><div class="text-4xl font-bold text-slate-800 my-4">R$ 9,90</div><ul class="space-y-3 text-sm text-slate-600 mb-8"><li>3 Simulados/dia</li><li>Ranking & Gabarito</li></ul><button onclick="app.initPayment('silver', 'pix')" class="w-full bg-emerald-100 text-emerald-700 font-bold py-3 rounded-xl mb-2">PIX</button><button onclick="app.initPayment('silver', 'card')" class="w-full border font-bold py-3 rounded-xl">Cart√£o</button></div><div class="bg-white rounded-2xl shadow-2xl border-4 border-yellow-400 p-6 text-center relative"><div class="absolute top-0 right-0 bg-yellow-400 text-black text-[9px] font-bold px-2 py-1 rounded-bl">BEST</div><h3 class="text-2xl font-bold text-slate-800">GOLD</h3><div class="text-4xl font-bold text-slate-900 my-4">R$ 19,90</div><ul class="space-y-3 text-sm text-slate-600 mb-8"><li><strong>Ilimitado</strong></li><li>Corre√ß√£o Real</li><li>Flashcards</li></ul><button onclick="app.initPayment('gold', 'pix')" class="w-full bg-yellow-400 text-yellow-900 font-bold py-3 rounded-xl mb-2">PIX</button><button onclick="app.initPayment('gold', 'card')" class="w-full border font-bold py-2 rounded-xl text-xs">Cart√£o (R$ 29,90)</button></div></div><button onclick="document.getElementById('upgrade-modal').classList.add('hidden')" class="absolute top-4 right-4 text-white text-2xl"><i class="fas fa-times"></i></button></div>

    <div id="checkout-modal" class="hidden fixed inset-0 bg-slate-900/80 z-[60] flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6"><div class="flex justify-between items-center mb-4"><h3 class="font-bold">Checkout</h3><button onclick="app.closeCheckout()"><i class="fas fa-times"></i></button></div><div id="pay-content" class="text-center py-4"></div></div></div>
    <div id="payment-success" class="hidden fixed inset-0 bg-emerald-500 z-[65] flex-col items-center justify-center text-center p-8 text-white"><h3 class="font-bold text-3xl mb-4">Sucesso!</h3><button onclick="app.finishUpgrade()" class="bg-white text-emerald-600 font-bold py-3 px-10 rounded-full shadow-xl">Continuar</button></div>

    <div id="leaderboard-modal" class="hidden fixed inset-0 bg-slate-900/70 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-3xl w-full max-w-md h-[80vh] flex flex-col relative"><div class="p-4 border-b flex justify-between"><h3 class="font-bold">Ranking</h3><button onclick="app.closeLeaderboard()"><i class="fas fa-times"></i></button></div><div id="leaderboard-content" class="p-0 overflow-y-auto flex-grow"></div><div id="leaderboard-locked-overlay" class="hidden absolute inset-0 top-14 bg-white/80 flex-col items-center justify-center"><button onclick="app.showUpgradeModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl shadow-lg">Liberar Premium</button></div></div></div>

    <div id="real-exam-modal" class="hidden fixed inset-0 bg-slate-900/80 z-[70] flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-4xl h-[90vh] flex flex-col"><div class="p-6 bg-teal-600 text-white flex justify-between"><h3 class="font-bold">Corre√ß√£o Real</h3><button onclick="document.getElementById('real-exam-modal').classList.add('hidden')"><i class="fas fa-times"></i></button></div><div id="real-exam-content" class="flex-grow overflow-y-auto p-6"><div id="real-exam-loading" class="text-center py-20">Carregando...</div><div id="real-exam-input" class="hidden"><div id="user-exam-grid" class="grid grid-cols-5 sm:grid-cols-10 gap-2"></div></div><div id="real-exam-result" class="hidden text-center"><div class="text-6xl font-bold" id="real-score-display"></div></div></div><div class="p-6 border-t flex justify-end" id="real-exam-footer"><button onclick="app.calculateRealScore()" class="bg-teal-600 text-white px-6 py-2 rounded">Calcular</button></div></div></div>
    
    <div id="admin-login-modal" class="hidden fixed inset-0 bg-slate-900/90 z-[90] flex items-center justify-center p-4"><div class="bg-white rounded-2xl p-8 max-w-sm w-full"><h3 class="font-bold text-xl mb-4">Admin</h3><input id="admin-email" class="w-full border p-2 mb-2"><input id="admin-pass" type="password" class="w-full border p-2 mb-4"><button onclick="app.handleAdminLogin()" class="w-full bg-slate-800 text-white py-2 rounded">Entrar</button><button onclick="document.getElementById('admin-login-modal').classList.add('hidden')" class="w-full mt-2 text-xs">Cancelar</button></div></div>
    <div id="admin-modal" class="hidden fixed inset-0 bg-slate-900/90 z-[80] flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-5xl h-[90vh] flex flex-col"><div class="p-4 bg-slate-800 text-white flex justify-between"><h3 class="font-bold">Admin Panel</h3><button onclick="document.getElementById('admin-modal').classList.add('hidden')"><i class="fas fa-times"></i></button></div><div class="p-8 overflow-y-auto flex-grow"><div id="admin-grid" class="grid grid-cols-5 sm:grid-cols-10 gap-2"></div></div><div class="p-6 border-t flex justify-end"><button onclick="app.saveOfficialKey()" class="bg-green-600 text-white px-6 py-2 rounded">Publicar</button></div></div></div>
    <div id="jump-menu" class="hidden fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-xl w-full max-w-lg h-[70vh] flex flex-col"><div class="p-4 border-b flex justify-between"><h3>Mapa</h3><button onclick="app.closeJumpMenu()"><i class="fas fa-times"></i></button></div><div id="jump-grid" class="p-4 grid grid-cols-5 gap-2 overflow-y-auto"></div></div></div>
    
    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, getDocs, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION (Replace with your real config)
        const firebaseConfig = {
          apiKey: "AIzaSyBNZ53HLq_GUviwRdO1qA27Q6eiE0dFInc",
          authDomain: "simulador-2b507.firebaseapp.com",
          projectId: "simulador-2b507",
          storageBucket: "simulador-2b507.firebasestorage.app",
          messagingSenderId: "1097583089104",
          appId: "1:1097583089104:web:c90293d58e1678dc3895d5",
          measurementId: "G-1N5MY4FC9S"
        };

        const appInstance = initializeApp(firebaseConfig);
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);
        const appId = "default-app-id";
        const ADMIN_EMAIL = "tlopes.dev@gmail.com";

        let currentUser = null;
        let userProfile = { subscription: 'free', dailyCount: 0, lastDate: "", history: [] };
        let checkPaymentInterval = null;
        let officialKeyData = null;
        
        // AUTH
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if(user) {
                if(user.displayName) document.getElementById('username').value = user.displayName;
                if(user.photoURL) document.getElementById('user-avatar-container').innerHTML = `<img src="${user.photoURL}" class="w-10 h-10 rounded-full border object-cover">`;
                document.getElementById('auth-status').innerHTML = '<span class="text-green-500 font-bold">Conectado</span>';
                document.getElementById('btn-logout').classList.remove('hidden');
                await loadProfile();
                if(new URLSearchParams(window.location.search).get('admin')==='true') document.getElementById('admin-panel-trigger').style.display='block';
            } else {
                document.getElementById('auth-status').innerText = "Visitante";
                document.getElementById('btn-logout').classList.add('hidden');
                userProfile = { subscription: 'free', dailyCount: 0 };
                app.updateUI();
            }
        });

        const toast = (msg,type='success')=>{
            const d=document.createElement('div'); d.className=`toast ${type} show`; d.innerHTML=`<span>${msg}</span>`;
            document.getElementById('toast-container').appendChild(d); setTimeout(()=>d.remove(),3000);
        };

        async function loadProfile() {
            if(!currentUser) return;
            try {
                const ref = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data');
                const snap = await getDoc(ref);
                const today = new Date().toISOString().split('T')[0];
                if(snap.exists()) {
                    userProfile = snap.data();
                    if(userProfile.lastDate !== today) { await updateDoc(ref, {dailyCount:0, lastDate:today}); userProfile.dailyCount=0; }
                } else {
                    userProfile = { subscription:'free', dailyCount:0, lastDate:today, history:[] };
                    await setDoc(ref, userProfile);
                }
                app.updateUI(); app.updateProbability();
            } catch(e){}
        }

        // QUIZ DATA
        const rnd = (min, max) => Math.floor(Math.random()*(max-min+1))+min;
        const state = { questions:[], answers:[], score:0, qIndex:0 };
        const generateQuestions = () => {
            const p=[]; for(let i=0; i<60; i++) {
                let t=`Quest√£o ${i+1}`, r="Explica√ß√£o...", a=0, c="Espec√≠ficos", w=1.0;
                if(i%5===0) { c="Racioc√≠nio L√≥gico"; let x=rnd(2,9),y=rnd(2,5); t=`Pr√≥ximo: ${x}, ${x+y}...`; a=2; w=0.5; }
                p.push({id:i+1, c, w, t, o:['A','B','C','D'], a, r});
            }
            return p;
        };
        const discursivePool = [{t:"Descreva Heimlich.", r:"Urg√™ncia"}];
        const flashcards = [{q:"Prazo Licen√ßa", a:"8 dias"}, {q:"Data Magna", a:"26/03"}];
        let fcIndex = 0;

        // APP METHODS
        const app = {
            updateUI: () => {
                const s = userProfile.subscription||'free';
                const badge = document.getElementById('user-badge');
                const label = document.getElementById('id-card-label');
                const card = document.getElementById('id-card');
                const credits = document.getElementById('credits-count');
                
                let max=1, txt="FREE", cls="bg-slate-100", cCls="border-slate-200", shine=false;
                if(s==='gold'){ max=999; txt="GOLD"; cls="bg-yellow-400"; cCls="border-yellow-400"; shine=true; }
                else if(s==='silver'){ max=3; txt="SILVER"; cls="bg-slate-300"; cCls="border-slate-300"; shine=true; }
                
                badge.innerText=txt; badge.className=`ml-1 text-[10px] px-2 rounded-full border ${cls}`;
                label.innerText=`PLANO ${txt}`;
                card.className=`p-4 rounded-2xl shadow-sm max-w-sm mx-auto md:mx-0 border ${cCls} ${shine?'premium-shine':'bg-white'}`;
                
                const rem = Math.max(0, max - (userProfile.dailyCount||0));
                credits.innerText = max>100 ? "‚àû" : rem;
                
                if(rem===0 && max<100) document.getElementById('limit-warning').classList.remove('hidden');
                else document.getElementById('limit-warning').classList.add('hidden');
                
                if(s==='gold') document.getElementById('real-exam-lock').className="fas fa-unlock text-teal-400";
                else document.getElementById('real-exam-lock').className="fas fa-lock text-slate-300";
            },

            updateProbability: () => {
                const h = userProfile.history || [];
                if(h.length===0) return;
                const avg = Math.round(h.reduce((a,b)=>a+b,0)/h.length);
                const prob = Math.min(99, Math.round(avg*0.8 + h.length*2));
                document.getElementById('gauge-path').style.strokeDasharray = `${prob}, 100`;
                document.getElementById('gauge-text').innerText = `${prob}%`;
                const chart = document.getElementById('stats-chart');
                if(chart) {
                    chart.innerHTML='';
                    h.slice(-10).forEach(s => {
                        const b=document.createElement('div'); b.className=`flex-1 rounded-t-md chart-bar ${s>=60?'bg-emerald-400':'bg-red-400'}`; b.style.height=`${Math.max(s,5)}%`; chart.appendChild(b);
                    });
                    document.getElementById('stats-avg').innerText = `${avg}%`;
                }
                if(userProfile.subscription!=='free') {
                    document.getElementById('stats-lock').classList.add('hidden');
                    document.getElementById('stats-weak').classList.remove('filter','blur-sm');
                    document.getElementById('stats-weak').innerText = "Calculando...";
                }
            },

            // QUIZ
            startQuiz: () => {
                if(!currentUser) return app.openAuthModal();
                const limit = userProfile.subscription==='gold'?999:(userProfile.subscription==='silver'?3:1);
                if((userProfile.dailyCount||0)>=limit) return app.showUpgradeModal();
                
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('quiz-screen').classList.remove('hidden');
                document.getElementById('loading-overlay').classList.remove('hidden'); document.getElementById('loading-overlay').classList.add('flex');
                setTimeout(()=>{
                    state.questions = generateQuestions();
                    state.answers = new Array(60).fill(null);
                    state.qIndex = 0;
                    document.getElementById('loading-overlay').classList.add('hidden'); document.getElementById('loading-overlay').classList.remove('flex');
                    app.renderQ();
                },1000);
            },
            renderQ: () => {
                const q = state.questions[state.qIndex];
                document.getElementById('question-text').innerText = q.t;
                const c = document.getElementById('options-container'); c.innerHTML='';
                q.o.forEach((opt,i)=>{
                    const b=document.createElement('button'); b.className=`option-card w-full text-left p-4 rounded-xl border mb-2 ${state.answers[state.qIndex]===i?'bg-indigo-50 border-indigo-500':'bg-white'}`;
                    b.innerText=opt; b.onclick=()=>{state.answers[state.qIndex]=i; app.renderQ();}; c.appendChild(b);
                });
                document.getElementById('progress-bar').style.width = `${((state.qIndex+1)/60)*100}%`;
                document.getElementById('prev-btn').classList.toggle('hidden', state.qIndex===0);
                document.getElementById('next-btn').classList.toggle('hidden', state.qIndex===59);
                document.getElementById('finish-btn').classList.toggle('hidden', state.qIndex!==59);
            },
            prevQuestion: ()=>{if(state.qIndex>0){state.qIndex--;app.renderQ();}},
            nextQuestion: ()=>{if(state.qIndex<59){state.qIndex++;app.renderQ(); window.scrollTo(0,0);}},
            finishQuiz: async () => {
                if(!confirm("Entregar?")) return;
                const limit = userProfile.subscription==='gold'?999:(userProfile.subscription==='silver'?3:1);
                if((userProfile.dailyCount||0)<limit) {
                    try{ await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data'), {dailyCount: increment(1)}); userProfile.dailyCount++; }catch(e){}
                }
                state.score = Math.floor(Math.random()*80); // Mock calc
                if(!userProfile.history) userProfile.history=[]; userProfile.history.push(Math.round((state.score/80)*100));
                await saveUserProfile();

                document.getElementById('final-score').innerText = state.score.toFixed(1);
                if(userProfile.subscription==='gold') {
                    document.getElementById('tab-btn-discursive').classList.remove('hidden');
                    document.getElementById('discursive-text').innerText = discursivePool[0].t;
                } else document.getElementById('tab-btn-discursive').classList.add('hidden');

                if(userProfile.subscription==='free') {
                     document.getElementById('review-premium-block').classList.remove('hidden');
                     document.getElementById('review-container').innerHTML='';
                } else {
                     document.getElementById('review-premium-block').classList.add('hidden');
                     const rc=document.getElementById('review-container'); rc.innerHTML='';
                     state.questions.forEach((q,i)=>{
                         const cor=state.answers[i]===q.a;
                         rc.innerHTML+=`<div class="p-4 border rounded ${cor?'bg-green-50 border-green-200':'bg-red-50 border-red-200'}"><p class="font-bold text-sm">${q.t}</p><p class="text-xs">${q.r}</p></div>`;
                     });
                }
                document.getElementById('quiz-screen').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
                try{ await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), {name:document.getElementById('username').value, score:state.score, uid:currentUser.uid, plan:userProfile.subscription, photoURL:currentUser.photoURL}); }catch(e){}
                window.scrollTo(0,0);
            },

            // FLASHCARDS
            openFlashcards: () => {
                if(userProfile.subscription!=='gold' && fcIndex>=3) return app.showUpgradeModal();
                document.getElementById('start-screen').classList.add('hidden');
                document.getElementById('flashcards-screen').classList.remove('hidden');
                app.renderFlashcard();
            },
            renderFlashcard: () => {
                if(fcIndex>=flashcards.length){ fcIndex=0; alert("Fim!"); location.reload(); return;}
                if(userProfile.subscription!=='gold' && fcIndex>=5) { document.getElementById('fc-lock').classList.remove('hidden'); document.getElementById('fc-lock').classList.add('flex'); return; }
                const c = flashcards[fcIndex];
                document.getElementById('fc-front').innerText = c.q; document.getElementById('fc-back').innerText = c.a;
                document.querySelector('.flashcard-inner').classList.remove('flipped');
                document.getElementById('flashcard-counter').innerText = `${fcIndex+1}/${flashcards.length}`;
            },
            nextFlashcard: () => { fcIndex++; app.renderFlashcard(); },

            // PAYMENT
            initPayment: async (plan, method) => {
                if(!currentUser) return app.openAuthModal();
                document.getElementById('upgrade-modal').classList.add('hidden');
                document.getElementById('checkout-modal').classList.remove('hidden');
                const c = document.getElementById('pay-content');
                c.innerHTML = '<div class="spinner-border w-8 h-8 border-4 rounded-full text-indigo-600 mx-auto mb-4"></div><p class="text-sm">Gerando...</p>';
                try {
                    const res = await fetch('/api/create-preference', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({userId:currentUser.uid, email:currentUser.email, plan, method}) });
                    const data = await res.json();
                    if(method==='pix'){
                        c.innerHTML = `<p class="text-xs font-bold mb-2">R$ ${data.price_charged}</p><img src="data:image/png;base64,${data.qr_code_base64}" class="w-40 h-40 mx-auto mb-2"><textarea class="w-full text-[10px] bg-slate-100 p-2" readonly>${data.qr_code}</textarea><button onclick="navigator.clipboard.writeText('${data.qr_code}');alert('Copiado')" class="text-indigo-600 font-bold text-xs mt-2">Copiar</button><div class="mt-4 text-xs text-green-600 animate-pulse font-bold">Aguardando...</div>`;
                        checkPaymentInterval = setInterval(async ()=>{
                            // Polling simulation. Real app uses onSnapshot listener on profile
                            if(Math.random()>0.9) app.finishUpgrade(plan);
                        }, 3000);
                    } else {
                        c.innerHTML = `<a href="${data.init_point}" target="_blank" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold block">Pagar</a>`;
                    }
                } catch(e){ c.innerHTML="Erro"; }
            },
            finishUpgrade: async (plan) => {
                if(checkPaymentInterval) clearInterval(checkPaymentInterval);
                if(plan) userProfile.subscription = plan; else userProfile.isPremium = true; // fallback
                await saveUserProfile();
                document.getElementById('checkout-modal').classList.add('hidden');
                document.getElementById('payment-success').classList.remove('hidden'); document.getElementById('payment-success').classList.add('flex');
                setTimeout(()=>{ document.getElementById('payment-success').classList.add('hidden'); app.updateUI(); }, 2000);
            },

            // MODALS & UTILS
            openAuthModal: (m='login') => { document.getElementById('auth-modal').classList.remove('hidden'); app.switchAuthMode(m); },
            switchAuthMode: (m) => { authMode=m; },
            handleGoogleLogin: async () => { try{ await signInWithPopup(auth, new GoogleAuthProvider()); document.getElementById('auth-modal').classList.add('hidden'); }catch(e){ alert("Erro Google"); } },
            handleAuth: async () => { const e=document.getElementById('auth-email').value, p=document.getElementById('auth-pass').value; try{ if(authMode==='login') await signInWithEmailAndPassword(auth,e,p); else await createUserWithEmailAndPassword(auth,e,p); document.getElementById('auth-modal').classList.add('hidden'); }catch(x){ toast(x.message,"error"); } },
            logout: async () => { await signOut(auth); location.reload(); },
            installPWA: async () => { if(window.deferredPrompt) window.deferredPrompt.prompt(); },
            
            openLeaderboard: async () => {
                document.getElementById('leaderboard-modal').classList.remove('hidden');
                const c = document.getElementById('leaderboard-content');
                const lk = document.getElementById('leaderboard-locked-overlay');
                c.innerHTML = '<div class="p-8 text-center"><div class="spinner-border w-8 h-8 border-4 rounded-full text-indigo-600 mx-auto"></div></div>';
                try {
                    const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'));
                    let l = []; snap.forEach(d=>l.push(d.data())); l.sort((a,b)=>b.score-a.score);
                    if(userProfile.subscription === 'free') {
                        lk.classList.remove('hidden'); lk.classList.add('flex');
                        c.innerHTML = l.slice(0,10).map((s,i)=>`<div class="flex justify-between p-3 border-b filter blur-[2px] opacity-50"><span>${i+1}. ${s.name}</span><span>${s.score}</span></div>`).join('');
                    } else {
                        lk.classList.add('hidden'); lk.classList.remove('flex');
                        c.innerHTML = l.slice(0,50).map((s,i)=>`<div class="flex justify-between p-3 border-b ${s.plan==='gold'?'bg-yellow-50':''}"><span>${i+1}. ${s.name} ${s.plan==='gold'?'üëë':''}</span><span class="font-bold text-indigo-600">${s.score}</span></div>`).join('');
                    }
                } catch(e){ c.innerHTML="Erro"; }
            },
            closeLeaderboard: () => document.getElementById('leaderboard-modal').classList.add('hidden'),
            
            openRealExamCorrection: () => {
                if(userProfile.subscription!=='gold') return app.showUpgradeModal();
                document.getElementById('real-exam-modal').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('real-exam-loading').classList.add('hidden');
                    document.getElementById('real-exam-input').classList.remove('hidden');
                    const g=document.getElementById('user-exam-grid'); g.innerHTML='';
                    for(let i=0;i<60;i++) g.innerHTML+=`<div class="text-center"><div class="text-[10px] text-slate-400">Q${i+1}</div><select class="w-full border rounded text-center"><option>-</option><option>A</option></select></div>`;
                }, 1000);
            },
            calculateRealScore: () => toast("Simula√ß√£o", "success"),
            
            showUpgradeModal: () => document.getElementById('upgrade-modal').classList.remove('hidden'),
            openCheckout: () => { document.getElementById('upgrade-modal').classList.add('hidden'); document.getElementById('checkout-modal').classList.remove('hidden'); },
            closeCheckout: () => document.getElementById('checkout-modal').classList.add('hidden'),
            openComparisonModal: () => document.getElementById('comparison-modal').classList.remove('hidden'),
            closeComparisonModal: () => document.getElementById('comparison-modal').classList.add('hidden'),
            switchTab: (t) => { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.getElementById(`tab-${t}`).classList.remove('hidden'); },
            filterReview: (t) => { document.querySelectorAll('#review-container > div').forEach(d => { if(t==='all') d.classList.remove('hidden'); else if(t==='wrong') d.classList.contains('border-emerald-200') ? d.classList.add('hidden') : d.classList.remove('hidden'); }); },
            showJumpMenu: () => document.getElementById('jump-menu').classList.remove('hidden'),
            closeJumpMenu: () => document.getElementById('jump-menu').classList.add('hidden'),
            
            openAdminLoginModal: () => document.getElementById('admin-login-modal').classList.remove('hidden'),
            handleAdminLogin: async () => { const e=document.getElementById('admin-email').value; if(e===ADMIN_EMAIL) { document.getElementById('admin-login-modal').classList.add('hidden'); document.getElementById('admin-modal').classList.remove('hidden'); } else alert("Negado"); },
            saveOfficialKey: () => alert("Salvo")
        };

        setInterval(() => {
            const t = new Date("2025-12-21").getTime() - new Date().getTime();
            document.getElementById('countdown-timer').innerText = t>0 ? Math.ceil(t/(1000*60*60*24))+" DIAS" : "HOJE!";
        }, 1000);

        window.app = app;
    </script>
</body>
</html>